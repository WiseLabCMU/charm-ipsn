\section{Evaluation}
\label{sec:eval}

{\color{blue} }
We implemented our system using 8 LPWAN boards as base stations
distributed across a university campus.  We used a Semtech SX1276 LoRaWAN
transmitter as the client device. We use Charm as the software platform at the
backend to support backhaul. We evaluate our system both through
proof-of-concept experiments and large-scale trace-driven simulations. We
perform our experiments in various environments(both indoors and outdoors) to
ensure the viability of the approach in different situations.

\subsection{Role of Transmission Rates on Battery Life}
\label{sec:energy-savings}

\begin{figure}[!htb]
\centering
\begin{tabular}{@{}c@{}}	
\subfloat[Typical client device current consumption for a complete LoRaWAN transmission. The device is powered at $3V$.]{\includegraphics[width=0.4\textwidth]{figures/bug_power_trace_annotated}
\label{fig:power-trace}} \\
\subfloat[Estimated lifetime of a client device powered by two AA batteries sending 36 byte packets at various data rates based on the energy profile.]{\includegraphics[width=0.4\textwidth]{figures/LoRaBug_AA_lifetime_semilog}
\label{fig:lifetime-estimates}}
\end{tabular}
\caption{}
\end{figure}

Most LP-WAN client devices are expected to be small, low-cost and low-maintenance battery-operated devices performing primarily some sensing functions. As these devices are expected to operate for many years, battery life is a major concern and is very difficult to optimize for. The amount of data to transmit is determined by the device and we do not attempt to alter it in this paper. Similarly, to maintain compatibility, we do not alter the MAC protocols or client device requirements specified in LoRaWAN.

We analyzed the energy profile of a typical client device, shown in \figref{power-trace}. The device performs some local computation, transmits a LoRa message, waits for an acknowledgement from the network and then goes to low-power sleep mode. The radio transmission consumes the highest amount of energy ($= \text{area under the curve} \times \text{voltage}$) by a large margin. Thus, any optimization to battery life must focus on reducing the energy of transmissions.

Two parameters affect the energy consumed by transmissions: (1) transmit power and (2) transmit time. Using the currently available LoRa radio chipsets (Semtech SX1272 and SX1276), we've observed that the transmit power does not significantly change the power drawn from the battery during transmission. Any optimization will thus have to focus on reducing the transmit time. The transmit time is determined by the data rate and the amount of data to send. We do not control the amount of data generated by client devices and thus, improving the data rate would provide the largest improvements.

\figref{lifetime-estimates} shows the estimated battery life of a client device if it were to communicate with different data rates. Wireless systems try to communicate at the highest data rate that does not cause too many errors. In the case of LoRa devices, switching to a slower data rate increases the spreading factor,  which have better sensitivity on the receiver. Thus, LoRa devices communicating at the highest spreading factors (and correspondingly using the lowest data rates) can communicate at much longer range and with higher reliability. The negative effect is a significant increase in their transmission time which severely affects battery life.

Using Charm's joint decoding strategy, we enable devices previously forced to use low data rates due to distance or bad coverage, to communicate at higher data rates and lengthen their battery life. Devices which could previously communicate with at least one base stations using the highest data rate reliably, thus gain no benefit from Charm.

\begin{figure}[!ht]
\centering
\includegraphics[width=0.45\textwidth]{figures/penetration_test_wean_cropped}
\compactimg
\caption{RF signal penetration experiments performed in a large poured-concrete building. (Left) shows the success rate for bi-directional packet exchange between end-node and gateway and (right) shows the RSSI at the gateway for successful transfers.}
\label{fig:penetration-test}
\end{figure}

This is useful to not only increase coverage but also in urban scenarios with lots of obstructions and devices deep inside buildings. \figref{penetration-test} shows a penetration test experiment inside an on-campus poured-concrete building. Despite a gateway being placed on the roof of the building, we observe the received signal strength to vary as much as 46 dBm at various locations inside the building. A number of client devices, deep inside structure, would have been forced to use the the slowest data rate but can now benefit from Charm.

\subsection{Local detection algorithm}
\label{sec:local-detection-eval}

\begin{figure}[!ht]
\centering
\includegraphics[width=0.45\textwidth]{figures/local_detection_limits}
\caption{{\color{blue} Add caption...}}
\label{fig:local-detection}
\end{figure}

{\color{blue} Akshay, Revathy, Swarun have to describe this

TODO: Add simulation plot.

Explain why there is a sudden jump from SF11 to SF12 detection?}

{\color{purple}
We performed trace-driven simulation to demonstrate the increase in detection capability of LoRa packets under noise. To perform this experiment we collect data at different spreading factors at high SNRs. We then measure the signal power and continuously keep adding white Gaussian noise to the signal. At every dB decrease in SNR, we test the state-of-the-art LoRaWAN decoding algorithm with Charm local and enhanced detection algorithm. From results shown in \figref{local-detection}, we show that Charm local detection algorithm far outperforms the LoRaWAN detection algorithm for detection of the packet. As we have described previously, Charm enhances algorithm builds on top of the local detection algorithm and hence performs better than it. We see a 33\% increase in the negative SNR under which a packet can be detected. We also highlight how the enhanced algorithm is able to leverage the nature of the data to increase the quality of detection at extremely low SNRs. 

This shows that this algorithm can detect packets even under heavy noise from far or occluded locations which allows us to only send data to the cloud only when we detect the arrival of a packet. This lowers the bandwidth usage of the backbone network by reducing the amount of data that needs to be sent to the cloud. Note that the extra detection range using the enhanced algorithm comes at a computation cost.
}


\subsection{Diversity gain}
\label{sec:diversity-gain-eval}

\begin{figure}[!ht]
\centering
\includegraphics[width=0.45\textwidth]{figures/diversity_gain}
\caption{{\color{blue} Add caption...}}
\label{fig:diversity-gain}
\end{figure}

{\color{blue} Akshay, Revathy, Swarun have to describe this

{\color{violet}
The calculation of diversity gain in Charm can provide the reader a better quantification on the improvement our system can bring in for the weaker transmissions. The parameter, diversity gain, is defined as the increase in SNR due to some diversity scheme, or the reduction in transmission power when a diversity scheme is introduced, without any loss of system performance. In Charm, we evaluate the diversity gain introduced by our system in terms of the improvement in SNR while coherently combining the multiple transmissions from geographically diverse receivers at a central server. Charm, on implementation in the test-bed has shown remarkable SNR improvements, thereby improving the SNR gains of stronger transmissions in addition to facilitating better decodability of transmissions from weaker clients which are below the noise floor. 
}

TODO: add plot of results}


\subsection{Effect on coverage and client data rates}
\label{sec:coverage-data-rate-improvement}

This section uses trace-driven simulations to show the advantages of Charm in improving coverage area and client energy consumption in both planned and unplanned gateway deployments. We use the log-distance path loss model to estimate the signal power at any given receiver. The model is calibrated using 4850 points collected in a varied urban environment at varying data rates and spreading factors using a GPS-connected LoRa client device. Our log-distance parameters are $L_0  = 98.0729 dB$ for $d_0 = 40.0 m$, $\gamma = 2.1495$ and flat fading $\sigma^2 = 100.0724$. Sensitivity values for the gateway are taken from \cite{Bor2016} to determine the SNR threshold required to decode a transmission. Since this is an urban environment with many obstacles and reflectors, we observe a maximum range of 3.77 km using a transmit power of 15 dBm as opposed to the marketed range of 10 km with line-of-sight. We provide an optimistic estimate and ignore the effects of fading (assume $\sigma^2 = 0$) in the simulation, since we are interested in the trend of changes.

\begin{figure*}[!htb]
\centering
\subfloat[Dense cells]{
\includegraphics[width=0.3\textwidth]{figures/dense_cells_charm_improvement_cropped}
\label{fig:dense-improvement}
} \hfill
\subfloat[Sparse cells]{
\includegraphics[width=0.3\textwidth]{figures/sparse_cells_charm_improvement_cropped}
\label{fig:sparse-improvement}
} \hfill
\subfloat[Random placement]{
\includegraphics[width=0.3\textwidth]{figures/random_placement_charm_improvement_cropped}
\label{fig:random-improvement}
}
\compactimg
\caption{{\color{blue} (Add caption)}}
\label{fig:charm-improvement}
\compactimg
\end{figure*}

Assuming the same transmit power on the client of 15 dBm, \figref{charm-improvement} shows the region where Charm's local detection followed by joint decoding shows an improvement in either coverage, client data rates or both compared to independent decoding on gateways (as is currently done in LoRaWAN). Imagine the regions with no coverage having a data rate of DR``-1'' = 0 bps (the next lowest data rate is DR0 = 960 bps using SF = 12). Every shade of green represents a region where a client device can increase its data rate by one and correspondingly reduce its transmission time by approximately half. Darker green areas represent regions where devices can switch by more than one data rate. The areas enclosed within the black boundary are regions that could be covered by the existing LoRaWAN system (that decodes on each gateway independently). As can be seen in each of the sub-figures, Charm shows an improvement in the coverage area (green regions outside the existing coverage region), an increase in client data rates (green regions inside the existing coverage region) as well as both simultaneously (darker green areas outside the existing coverage area).

\figref{dense-improvement} shows an ideal planned deployment where gateways are placed in a dense hexagonal grid 6.53 km apart from each other (corresponding to $2*3.77*\cos(\pi/6)$ km). Such an arrangement, popular in cellular deployments, provides optimal coverage with no gaps when using an independent decoding scheme. However, the points farthest from the gateways (e.g. on the centroid between three neighbouring gateways) have to use the slowest data rates (corresponding to SF12) and their battery life correspondingly suffers. If such a deployment were to be augmented with Charm, the region between the gateways can all communicate using SF9 or better. For the centroid points, this reduces the transmit time by approximately a factor of 8 and leads to huge energy savings. Additionally, we see the coverage area for joint decoding has expanded beyond the original coverage region. Some of the devices in the expanded coverage area can even communicate with higher data rates. An interesting phenomenon seen in each of the sub-figures are the thin concentric circles of improvement around each gateway. These are regions just outside the original boundaries covered by any given spreading factor that also gain a data rate increase due to joint decoding. However, this effect is not as prominent and the circles are small.

\figref{sparse-improvement} shows a sparse cellular arrangement with gateways 10.05 km apart from each other that can provide gap-free coverage. Charm thus enables decreasing the gateway density by a factor of 2.37 (proportional to square of inter-gateway distance $=(10.05/6.53)^2$) while providing the same level of coverage. Finally, we show in \figref{random-improvement} how Charm also improves the performance of an unplanned deployment of user-deployed gateways by improving coverage area as well as data rates for clients. Another interesting phenomenon to observe here is that Charm's joint decoding manages to fill in islands and orphaned regions. This is particularly relevant to urban regions where areas of bad coverage are formed in building basements and other indoor regions as seen in \figref{penetration-test}.

Given that these are optimistic estimates, there may be cases where joint decoding may not work as well and the gain may be lower due to lack of diversity in the signal. However, with a large number of gateways in very diverse geographical locations (particularly resulting from UGWs), a situation where joint decoding provides no improvement is very unlikely.

